# cdt-builds

conda-forge CDT builds


## Adding a CDT package

To add a CDT package, make a PR on this repo with the following changes.

1. Add the name of the CDT `cdt_slugs.yaml` file.
2. Run the python script `gen_cdt_recipes.py`. This script will take about 10-20
   minutes to complete and will regenerate all of the CDT recipes.
3. Commit any changes from steps 1+2 and open the PR.

The CI service will build the CDTs, report any errors, etc.


## Changing the CDT generation script `rpm.py`

If you make changes to the CDT generation script, make a PR on this repo using
the following steps.

1. Make sure the bump the `cdt_build_number` variable in the `conda_build_config.yaml` file.
2. Run the python script `gen_cdt_recipes.py`. This script will take about 10-20
   minutes to complete and will regenerate all of the CDT recipes.
3. Commit any changes from steps 1+2 and open the PR.

The CI service will build the CDTs, report any errors, etc.


## Making Custom CDT recipes

If you have a CDT recipe that is not autogenerated, it can be added as follows.

1. Add the CDT name to the `cdt_slugs.yaml` file. Make sure to set `custom: true`
   in the metadata in the file.
2. Add the CDT recipe in a directory under the full CDT package name in either
   the `custom_cdts` or `legacy_custom_cdts` folder depending on whether or not
   the CDT is targeted at the old-style CDT format or the new-style one. If you
   do not know, ask someone on `conda-forge/core`.
3. Commit any changes from steps 1+2 and open the PR.

The CI service will build the CDTs, report any errors, etc.


## Old-style/legacy vs. New-style CDTs

The old-style CDTs are targeted at the conda-forge compilers that do not use the
`sysroot_{conda subdir}` packages (e.g., `sysroot_linux-64`, `sysroot_linux-aarch64`, etc.)
and build their own copy of glibc. These compilers also have `cos6` or `cos7`
in the name of the sysroot directory. The new-style CDTs use a sysroot directory
without `cos6` or `cos7` and are meant to work with the new conda-forge
compilers that depend on the `sysroot_{conda subdir}` packages.

**old-style CDT specs**
- needs to have `no_hoist` in the source sections
- sysroot directory has `conda_cos6` or `conda_cos7` in the path
- needs to have `run_constrained` entry of `sysroot_{conda subdir} ==99999999999` to prevent
  it from being co-installed w/ the new compilers or CDTs

**new-style CDT specs**
- needs to have `no_hoist` in the source sections
- sysroot directory has `conda` only in the path
- needs to have a `run` requirement on the proper version of the
  `sysroot_{subdir}` package so that it is only installed with CDTs from the
  right version of CentOS
- the versions of `sysroot_{conda subdir}` are 2.12 for CentOS 6 and 2.17 for CentOS 7.

## Azure CI Setup

This bit of code was run to setup azure. 

```python
from conda_smithy.azure_ci_utils import register_repo, AzureConfig

cfg = AzureConfig(project_name='cdt-builds')
register_repo("conda-forge", "cdt-builds", config=cfg)
```
